# –°–∏—Å—Ç–µ–º–∞ –±–æ—è –∏ –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—ã

## –û–±–∑–æ—Ä
–ú–µ—Ö–∞–Ω–∏–∫–∞ –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—ã –¥–ª—è D&D —Å–µ—Å—Å–∏–π - GM –∑–∞–ø—É—Å–∫–∞–µ—Ç –±–æ–π, –∏–≥—Ä–æ–∫–∏ –±—Ä–æ—Å–∞—é—Ç d20, —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –ø–æ —É–±—ã–≤–∞–Ω–∏—é.

## –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### 1. GM Interface - –ö–Ω–æ–ø–∫–∞ "–ë–æ–π"

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å GM –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞, –≤–∫–ª–∞–¥–∫–∞ "–ë–æ–π"

**–ü–æ–≤–µ–¥–µ–Ω–∏–µ**:
- –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: –∫–Ω–æ–ø–∫–∞ "–í–∫–ª—é—á–∏—Ç—å –±–æ–π" –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞ (–±–æ–π –Ω–µ –Ω–∞—á–∞—Ç)
- –ü—Ä–∏ –∫–ª–∏–∫–µ:
  - –ë–æ–π –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è (—Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)
  - –ö–Ω–æ–ø–∫–∞ –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ "–ó–∞–≤–µ—Ä—à–∏—Ç—å –±–æ–π"
  - –£ –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –æ–∫–Ω–æ –±—Ä–æ—Å–∫–∞ –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—ã

**API**:
```
POST /api/combat/start
POST /api/combat/end
```

**WebSocket —Å–æ–±—ã—Ç–∏–µ**:
```json
{
  "type": "combat_started",
  "data": {}
}
```

---

### 2. Player Interface - –û–∫–Ω–æ –±—Ä–æ—Å–∫–∞ –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—ã

**–¢—Ä–∏–≥–≥–µ—Ä**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ WebSocket —Å–æ–±—ã—Ç–∏—è `combat_started`

**UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç**: `InitiativeRollModal.vue`
- –í–∏–∑—É–∞–ª—å–Ω–æ –ø–æ—Ö–æ–∂ –Ω–∞ `RollResult.vue`
- –í —Ü–µ–Ω—Ç—Ä–µ: –±–æ–ª—å—à–∞—è –∏–∫–æ–Ω–∫–∞ –∫—É–±–∏–∫–∞ d20 (üé≤)
- –¢–µ–∫—Å—Ç: "–ë—Ä–æ—Å–æ–∫ –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—ã"
- **–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å**: –ö–ª–∏–∫ –ø–æ –∫—É–±–∏–∫—É = –±—Ä–æ—Å–æ–∫ d20
- –ü–æ—Å–ª–µ –±—Ä–æ—Å–∫–∞: –ø–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –æ–∫–Ω–æ –∞–≤—Ç–æ–∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏**:
- ‚úÖ –¢–æ–ª—å–∫–æ –æ–¥–∏–Ω –∫—É–±–∏–∫ - d20
- ‚úÖ –ë—Ä–æ—Å–æ–∫ **–ø—Ä–∏–≤–∞—Ç–Ω—ã–π** - –≤–∏–¥–µ–Ω —Ç–æ–ª—å–∫–æ –∏–≥—Ä–æ–∫—É –∏ GM
- ‚úÖ –ù–ï —Ç—Ä–∞–Ω—Å–ª–∏—Ä—É–µ—Ç—Å—è –¥—Ä—É–≥–∏–º –∏–≥—Ä–æ–∫–∞–º —á–µ—Ä–µ–∑ `dice_result`
- ‚úÖ –ù–µ–ª—å–∑—è –∑–∞–∫—Ä—ã—Ç—å –±–µ–∑ –±—Ä–æ—Å–∫–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ)

**API**:
```
POST /api/combat/initiative
Body: { "player_id": 123 }
Response: { "roll": 15, "player_name": "–î–∞—Ä–∞–∫" }
```

**WebSocket —Å–æ–±—ã—Ç–∏–µ** (—Ç–æ–ª—å–∫–æ –¥–ª—è GM):
```json
{
  "type": "initiative_rolled",
  "data": {
    "player_id": 123,
    "player_name": "–î–∞—Ä–∞–∫",
    "roll": 15
  }
}
```

---

### 3. GM Interface - –í–∫–ª–∞–¥–∫–∞ "–ë–æ–π"

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å GM, –≤–∫–ª–∞–¥–∫–∞ "–ë–æ–π" (CombatTab.vue)

**–°–æ–¥–µ—Ä–∂–∏–º–æ–µ**:
1. –ö–Ω–æ–ø–∫–∞ "–í–∫–ª—é—á–∏—Ç—å –±–æ–π" / "–ó–∞–≤–µ—Ä—à–∏—Ç—å –±–æ–π"
2. **–°–ø–∏—Å–æ–∫ –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—ã** (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∫–æ–≥–¥–∞ –±–æ–π –∞–∫—Ç–∏–≤–µ–Ω)

**–°–ø–∏—Å–æ–∫ –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—ã**:
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –ü–æ—Ä—è–¥–æ–∫ –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—ã          ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ ü•á –î–∞—Ä–∞–∫          19        ‚îÇ
‚îÇ ü•à –≠–ª—å—Ñ–∏–π–∫–∞       15        ‚îÇ
‚îÇ ü•â –ì–æ–±–ª–∏–Ω (NPC)   12        ‚îÇ
‚îÇ    –û—Ä–∫ (NPC)       8        ‚îÇ
‚îÇ    –ú–∞–≥             -        ‚îÇ  ‚Üê –Ω–µ –±—Ä–æ—Å–∏–ª
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞**: –ü–æ —É–±—ã–≤–∞–Ω–∏—é —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –±—Ä–æ—Å–∫–∞
- –ò–≥—Ä–æ–∫–∏ –±–µ–∑ –±—Ä–æ—Å–∫–∞ –≤ –∫–æ–Ω—Ü–µ —Å–ø–∏—Å–∫–∞ (—Å–µ—Ä—ã–º)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –±—Ä–æ—Å–∫–∞

**–î–∞–Ω–Ω—ã–µ**:
```typescript
interface InitiativeEntry {
  player_id: number
  player_name: string
  character_name?: string
  roll: number | null
  is_npc: boolean
}
```

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### Backend

**–ù–æ–≤–∞—è –º–æ–¥–µ–ª—å**:
```python
class CombatState(Base):
    id: int
    session_id: int
    is_active: bool
    started_at: datetime
```

**–ù–æ–≤–∞—è –º–æ–¥–µ–ª—å**:
```python
class InitiativeRoll(Base):
    id: int
    combat_id: int
    player_id: int
    roll: int
    rolled_at: datetime
```

**Endpoints**:
- `POST /api/combat/start` - –Ω–∞—á–∞—Ç—å –±–æ–π
- `POST /api/combat/end` - –∑–∞–≤–µ—Ä—à–∏—Ç—å –±–æ–π
- `POST /api/combat/initiative` - –±—Ä–æ—Å–æ–∫ –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—ã
- `GET /api/combat/state` - –ø–æ–ª—É—á–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –±–æ—è
- `GET /api/combat/initiative` - –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—ã

### Frontend

**–ù–æ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã**:
- `components/combat/InitiativeRollModal.vue` - –º–æ–¥–∞–ª–∫–∞ –±—Ä–æ—Å–∫–∞ –¥–ª—è –∏–≥—Ä–æ–∫–∞
- `components/combat/InitiativeList.vue` - —Å–ø–∏—Å–æ–∫ –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—ã –¥–ª—è GM
- –û–±–Ω–æ–≤–∏—Ç—å `components/gm/tabs/CombatTab.vue` - –¥–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É –∏ —Å–ø–∏—Å–æ–∫

**–ù–æ–≤—ã–π store**:
```typescript
// stores/combat.ts
const useCombatStore = defineStore('combat', () => {
  const isActive = ref(false)
  const initiativeList = ref<InitiativeEntry[]>([])

  async function startCombat() { ... }
  async function endCombat() { ... }
  async function rollInitiative() { ... }
  function setupWebSocketHandlers() { ... }
})
```

---

## –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö

### 1. –ù–∞—á–∞–ª–æ –±–æ—è
```
GM: –ö–ª–∏–∫ "–í–∫–ª—é—á–∏—Ç—å –±–æ–π"
  ‚Üí POST /api/combat/start
  ‚Üí WebSocket broadcast: combat_started
  ‚Üí –í—Å–µ –∏–≥—Ä–æ–∫–∏: –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è InitiativeRollModal
  ‚Üí GM: –∫–Ω–æ–ø–∫–∞ –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ "–ó–∞–≤–µ—Ä—à–∏—Ç—å –±–æ–π"
```

### 2. –ë—Ä–æ—Å–æ–∫ –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—ã
```
–ò–≥—Ä–æ–∫: –ö–ª–∏–∫ –Ω–∞ –∫—É–±–∏–∫ –≤ InitiativeRollModal
  ‚Üí POST /api/combat/initiative
  ‚Üí WebSocket (—Ç–æ–ª—å–∫–æ GM): initiative_rolled
  ‚Üí GM: InitiativeList –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∏ –ø–µ—Ä–µ—Å–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è
  ‚Üí –ò–≥—Ä–æ–∫: –≤–∏–¥–∏—Ç —Å–≤–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –º–æ–¥–∞–ª–∫–∞ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è
```

### 3. –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –±–æ—è
```
GM: –ö–ª–∏–∫ "–ó–∞–≤–µ—Ä—à–∏—Ç—å –±–æ–π"
  ‚Üí POST /api/combat/end
  ‚Üí WebSocket broadcast: combat_ended
  ‚Üí –í—Å–µ –∫–ª–∏–µ–Ω—Ç—ã: –æ—á–∏—Å—Ç–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –±–æ—è
  ‚Üí GM: InitiativeList –æ—á–∏—â–∞–µ—Ç—Å—è
```

---

## –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î

```sql
CREATE TABLE combat_states (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    session_id INTEGER NOT NULL,
    is_active BOOLEAN NOT NULL DEFAULT 0,
    started_at TIMESTAMP,
    FOREIGN KEY (session_id) REFERENCES sessions(id)
);

CREATE TABLE initiative_rolls (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    combat_id INTEGER NOT NULL,
    player_id INTEGER NOT NULL,
    roll INTEGER NOT NULL,
    rolled_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (combat_id) REFERENCES combat_states(id),
    FOREIGN KEY (player_id) REFERENCES players(id)
);
```

---

## –ü–æ—Ä—è–¥–æ–∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

1. **Backend**: –ú–æ–¥–µ–ª–∏ CombatState, InitiativeRoll + –º–∏–≥—Ä–∞—Ü–∏—è
2. **Backend**: API endpoints (combat.py)
3. **Backend**: WebSocket —Å–æ–±—ã—Ç–∏—è –≤ manager.py
4. **Frontend**: combat store
5. **Frontend**: InitiativeRollModal.vue
6. **Frontend**: InitiativeList.vue
7. **Frontend**: –û–±–Ω–æ–≤–∏—Ç—å CombatTab.vue
8. **Frontend**: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ GMView –∏ PlayerView
9. **Testing**: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –∏–≥—Ä–æ–∫–∞–º–∏
10. **Changelog**: –û–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é

---

## –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è (–Ω–µ –≤ —ç—Ç–æ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏)

- –ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—ã (dexterity bonus)
- –†–µ-—Ä–æ–ª–ª –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—ã
- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Ç–µ–∫—É—â–µ–≥–æ —Ö–æ–¥–∞ –≤ –±–æ—é
- HP tracking –≤–æ –≤—Ä–µ–º—è –±–æ—è
- –ò—Å—Ç–æ—Ä–∏—è –¥–µ–π—Å—Ç–≤–∏–π –≤ –±–æ—é
