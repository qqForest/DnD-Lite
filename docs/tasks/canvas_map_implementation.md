# Реализация карты на Canvas (MVP)

## Обзор
Цель — создать интерактивную карту для DnD сессий с использованием Canvas. Реализация должна быть производительной, поддерживать масштабирование (зум/пан) и синхронизацию состояния между игроками в реальном времени.

## Технологический стек

### Frontend
**Библиотека**: `Konva.js` (через обёртку `vue-konva`).
**Почему Konva?**
- Высокая производительность для 2D объектов.
- Встроенная поддержка drag&drop, событий мыши/тача.
- Слои (Layers) для разделения фона, сетки, токенов и тумана войны.
- Удобное API для трансформаций (масштабирование, вращение).
- Поддержка экспорта/импорта состояния (JSON).

### Backend
**База данных**: Новые таблицы в SQLite (через SQLAlchemy).
**API**: REST для загрузки состояния, WebSocket для синхронизации изменений.

## Архитектура данных (Backend)

### Модели (алхимия)
1. **Map**
    - `id`: UUID
    - `session_id`: UUID (связь с сессией)
    - `name`: String
    - `background_url`: String (или путь к файлу)
    - `width`: Integer (пиксели или клетки)
    - `height`: Integer
    - `grid_scale`: Integer (размер клетки в пикселях, по умолчанию 50)
    - `is_active`: Boolean (текущая активная карта)

2. **MapToken** (объекты на карте)
    - `id`: UUID
    - `map_id`: UUID
    - `character_id`: UUID (nullable, если это просто объект/монстр без чарника)
    - `x`: Float
    - `y`: Float
    - `scale`: Float
    - `rotation`: Float
    - `layer`: String (например, 'tokens', 'background', 'hidden')
    - `metadata`: JSON (для hp, статусов и прочего)

## Синхронизация (WebSocket)

### События (Server -> Client)
- `map_changed`: GM сменил активную карту (загрузка новой сцены).
- `token_moved`: Токен перемещён (обновление координат `id`, `x`, `y`).
- `token_updated`: Изменение свойств (hp, scale).

### События (Client -> Server)
- `move_token`: Отправка новых координат (с троттлингом или по окончанию драга).
- `ping_map`: Указка (ping) для привлечения внимания.

## План реализации (MVP)

### Этап 1: Базовая настройка
1. Добавить `konva` и `vue-konva` в `package.json` фронтенда.
2. Обновить Docker-образ фронтенда.

### Этап 2: Бэкенд
1. Создать модели `Map` и `MapToken` в `app/models/map.py`.
2. Создать схемы Pydantic в `app/schemas/map.py`.
3. Реализовать CRUD роутеры в `app/api/maps.py`.
4. Добавить WebSocket обработчики для движения токенов.

### Этап 3: Фронтенд (Компонент карты)
1. Создать компонент `GameMap.vue`.
2. Реализовать структуру слоёв Konva:
    - **Stage**: Основной канвас, обработка зума/пана (wheel + drag).
    - **Layer (Background)**: Изображение карты.
    - **Layer (Grid)**: Сетка (рисование линий в цикле).
    - **Layer (Tokens)**: Токены персонажей (Circle/Image + Text).
3. Интеграция с WebSocket: слушать события движения и анимировать перемещение чужих токенов.

### Этап 4: GM Инструменты (позже)
- Загрузка изображений карт.
- "Туман войны" (Fog of War) — отдельный слой с маской прозрачности.
- Рисование поверх карты.

## Заметки по реализации
- **Координаты**: Хранить абсолютные координаты (x, y) относительно начала карты, а не экрана.
- **Зум**: Реализовать через `stage.scale({ x: scale, y: scale })`.
- **Drag&Drop**: Использовать встроенный `draggable` в Konva, обновлять координаты на `dragend` для сохранения в БД, но транслировать `dragmove` через WS для плавности у других игроков (с троттлингом 50-100мс).
