# Система аутентификации (JWT)

В DnD Lite GM используется система аутентификации на основе **JSON Web Tokens (JWT)** с использованием Bearer-токенов и механизма обновления (Refresh Token).

## Обзор

Система заменила простую передачу UUID в параметрах запроса на стандартную индустриальную схему. Теперь каждый защищенный запрос должен содержать заголовок `Authorization: Bearer <access_token>`.

### Типы токенов

1.  **Access Token (Токен доступа):**
    *   Короткоживущий (по умолчанию 30 минут).
    *   Используется для авторизации каждого API-запроса.
    *   Содержит `sub` (внутренний UUID игрока) и `type: access`.

2.  **Refresh Token (Токен обновления):**
    *   Долгоживущий (по умолчанию 30 дней).
    *   Используется только для получения нового Access токена, когда старый истекает.
    *   Хранится в LocalStorage (в данной реализации) и передается на эндпоинт `/api/session/auth/refresh`.

---

## Реализация (Backend)

### Зависимости
Для работы используются библиотеки `python-jose` (шифрование) и `passlib` (хотя паролей нет, она полезна для расширений).

### Конфигурация (`app/config.py`)
Настройки JWT задаются через переменные окружения или значения по умолчанию:
*   `JWT_SECRET_KEY`: Секретный ключ для подписи (обязательно смените в продакшене!).
*   `JWT_ALGORITHM`: Алгоритм шифрования (HS256).
*   `ACCESS_TOKEN_EXPIRE_MINUTES`: Время жизни доступа.
*   `REFRESH_TOKEN_EXPIRE_DAYS`: Время жизни обновления.

### Основные компоненты (`app/core/auth.py`)
*   `create_access_token(data)`: Создает подписанный JWT для доступа.
*   `create_refresh_token(data)`: Создает подписанный JWT для обновления.
*   `get_current_player(token)`: FastAPI Dependency. Декодирует токен, проверяет его валидность и возвращает объект `Player` из базы данных. Если токен невалиден — выбрасывает `401 Unauthorized`.

---

## Реализация (Frontend)

Аутентификация на фронтенде полностью автоматизирована через сервис Axios.

### Перехватчики (Interceptors)
Файл: `frontend/src/services/api.ts`

1.  **Request Interceptor:** Автоматически добавляет заголовок `Authorization: Bearer ...` ко всем запросам, если токен есть в `localStorage`.
2.  **Response Interceptor (401 Handler):**
    *   Если сервер возвращает `401 Unauthorized`, фронтенд встает на паузу.
    *   Выполняется запрос к `/api/session/auth/refresh` с текущим Refresh токеном.
    *   Если обновление успешно: новые токены сохраняются, и все "упавшие" запросы повторяются прозрачно для пользователя.
    *   Если обновление не удалось (токен истек совсем): пользователь разлогинивается и перенаправляется на главную.

### Хранилище (`frontend/src/stores/session.ts`)
Store управляет состоянием токенов и их сохранением в `localStorage` при создании или подключении к сессии.

---

## WebSocket и JWT

**Важно:** Для WebSocket соединений по-прежнему используется исходный `token` (UUID) в качестве query-параметра (`/ws?token=...`). Это связано с тем, что:
1. Браузерные WebSocket API не поддерживают кастомные заголовки (Bearer).
2. Исходный UUID токен игрока является уникальным и неизменяемым идентификатором канала связи, в то время как JWT — это движущийся объект с временем истечения.

JWT используется только для **REST API** операций.

---

## Эндпоинты

| Метод | Путь | Описание | Авторизация |
| :--- | :--- | :--- | :--- |
| POST | `/api/session` | Создание сессии, выдает токены GM | Нет |
| POST | `/api/session/join` | Вход в сессию, выдает токены игрока | Нет |
| POST | `/api/session/auth/refresh` | Обмен Refresh токена на новый Access | Refresh Token |
| GET | `/api/session` | Получение состояния текущей сессии | Bearer Access |
| ANY | `/api/characters/*` | Операции с персонажами | Bearer Access |
| ANY | `/api/combat/*` | Операции с боем | Bearer Access |
| ANY | `/api/dice/*` | Броски кубиков | Bearer Access |
